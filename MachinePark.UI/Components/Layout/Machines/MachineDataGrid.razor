@inject HttpClient ApiClient
@inject IDialogService DialogService

<MudContainer Class="d-flex flex-column mb-5">
    <Element Class="mb-5 d-flex align-center ">
        <MudIcon Class="mr-2" Icon="@Icons.Material.Filled.TableView" />
        <h2>Machines</h2>
    </Element>
    @if (ApiState == ApiState.Reachable)
    {
        if(Machines is not null && Machines.Any())
        {
            <MudPaper Elevation="25">
                <MachineToolBar MachineAdded="@OnMachineAdded"/>
                <MudDivider />
                <MudDataGrid Items="@Machines" Hover="true" ColumnResizeMode="@ResizeMode.Container" DragDropColumnReordering="true"
                    RowsPerPage="10">
                    <Columns>
                        <PropertyColumn Property="m => m.Id" />
                        <PropertyColumn Property="m => m.Name" />
                        <PropertyColumn Property="m => m.Online" />
                        <PropertyColumn Property="m => m.Section" />
                        <PropertyColumn Property="m => m.CreatedAt" Title="Created At" />
                        <PropertyColumn Property="m => m.UpdatedAt" Title="Updated At" />
                        <TemplateColumn T="MachineModel">
                            <CellTemplate>
                                <MudTooltip Text="Delete Machine">
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" aria-label="delete machine"
                                        OnClick="@(() => DeleteMachine(context.Item))" />
                                </MudTooltip>
                            </CellTemplate>
                        </TemplateColumn>
                        <TemplateColumn T="MachineModel">
                            <CellTemplate>
                                <MudTooltip Text="Edit Machine">
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit" aria-label="edit machine"
                                        OnClick="@(() => EditMachine(context.Item))" />
                                </MudTooltip>
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                    <PagerContent>
                        <MudDataGridPager T="MachineModel" PageSizeOptions=@(new int[] {5, 10, 20}) />
                    </PagerContent>
                </MudDataGrid>
            </MudPaper>
        } 
        else {
            <MudPaper>
                <MudAlert Severity="Severity.Info">No data available</MudAlert>
            </MudPaper>
        }
    }
    else
    {
        <MudPaper>
            <MudAlert Severity="Severity.Error">API not available</MudAlert>
        </MudPaper>
    }
</MudContainer>

@code {

    [Parameter]
    public IEnumerable<MachineModel>? Machines { get; set; } = [];

    [Parameter]
    public ApiState ApiState { get; set; }

    [Parameter]
    public EventCallback DataUpdate { get; set; }

    private async Task EditMachine(MachineModel model)
    {
        var options = new DialogOptions { CloseOnEscapeKey = true };
        var parameters = new DialogParameters<EditMachineDialog> { { d => d.FormModel, model } };
        var dialog = DialogService.Show<EditMachineDialog>(null, parameters, options);
        var result = await dialog.Result;
        if(!result.Cancelled) {
            await DataUpdate.InvokeAsync();
        }
    }

    private async Task OnMachineAdded() {
        await DataUpdate.InvokeAsync();
    }

    private async Task DeleteMachine(MachineModel model)
    {
        try
        {
            var response = await ApiClient.DeleteAsync($"machines/{model.Id}");
            if (response.IsSuccessStatusCode)
            {
                await DataUpdate.InvokeAsync();
            }
            else
            {
                Log.Error("Encountered error: " + response.StatusCode.ToString());
            }
        }
        catch (Exception ex)
        {
            Log.Error(ex.Message);
        }
    }
}